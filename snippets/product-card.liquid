{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT CARD COMPONENT (Customized for Image Swatches)
----------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

{%- liquid
  if hide_product_information
    assign show_badges = false
    assign show_rating = false
    assign show_vendor = false
    assign show_title = false
    assign show_prices = false
    assign show_swatches = false
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
  else
    assign show_badges = show_badges | default: true, allow_false: true
    assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true
    assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_title = true
    assign show_prices = true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
    assign show_swatches = show_swatches | default: true, allow_false: true
  endif
-%}

<product-card class="product-card" {% if reveal %}reveal-on-scroll="true"{% endif %} handle="{{ product.handle | escape }}">
  
  {%- comment -%}
  --------------------------------------------------------------------------------------------------------------------
  PRODUCT MEDIA
  --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  {%- if product.media.size > 0 -%}
    <div class="product-card__figure">
      {%- if show_badges -%}
        {%- render 'product-badges', product: product, vertical: true -%}
      {%- endif -%}

      <a href="{{ product.url }}" class="product-card__media" data-instant>
        {%- capture sizes -%}
          {%- if stacked -%}
            (max-width: 699px) calc(100vw / {{ section.settings.products_per_row_mobile }}), (max-width: 999px) calc(100vw / {{ 3 | at_most: section.settings.products_per_row_desktop | default: 3 }} - 64px), calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
          {%- else -%}
            (max-width: 699px) 74vw, (max-width: 999px) 38vw, calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
          {%- endif -%}
        {%- endcapture -%}

        {%- capture main_image_classes -%}product-card__image product-card__image--primary {% if settings.product_image_aspect_ratio contains 'crop' %}object-cover{% endif %} aspect-{{ settings.product_image_aspect_ratio | split: '_' | first }}{%- endcapture -%}
        
        {%- comment -%} Added ID for JS targeting {%- endcomment -%}
        {{- product.featured_media | image_url: width: product.featured_media.width | image_tag: id: product_image_id, loading: 'lazy', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800', class: main_image_classes, id: product.id -}}

        {%- if show_secondary_image and product.media.size > 1 -%}
          {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
          {{- next_media | image_url: width: next_media.width | image_tag: class: 'product-card__image product-card__image--secondary', loading: 'lazy', fetchpriority: 'low', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800' -}}
        {%- endif -%}
      </a>

      {%- if show_quick_buy and product.available -%}
        {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
          {%- form 'product', product, is: 'product-form' -%}
            <input type="hidden" name="on_success" value="force_open_drawer">
            <input type="hidden" name="quantity" value="1">
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <button type="submit" class="product-card__quick-add-button">
              <span class="sr-only">{{ 'product.general.add_to_cart_button' | t }}</span>
              {%- render 'icon' with 'plus' -%}
            </button>
          {%- endform -%}
        {%- else -%}
          {%- capture quick_buy_id -%}product-quick-buy-{{ section.id }}-{{ block.id }}-{{ quick_buy_context }}-{{ product.id }}{%- endcapture -%}

          <button type="button" aria-controls="{{ quick_buy_id }}" class="product-card__quick-add-button">
            <span class="sr-only">{{ 'product.general.choose_options' | t }}</span>
            {%- render 'icon' with 'plus' -%}
          </button>

          <quick-buy-modal handle="{{ product.handle }}" class="quick-buy-modal modal" id="{{ quick_buy_id }}">
          </quick-buy-modal>
        {%- endif -%}
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- comment -%}
  --------------------------------------------------------------------------------------------------------------------
  PRODUCT INFO
  --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  <div class="product-card__info empty:hidden">
    {%- assign text_class = '' -%}

    {%- if settings.product_card_text_font == 'heading' -%}
      {%- assign text_class = 'h6' -%}
    {%- endif -%}

    {%- if show_title or show_prices or show_vendor and product.vendor != blank -%}
      <div class="v-stack justify-items-center gap-2">
        {%- if show_vendor and product.vendor != blank -%}
          {%- capture vendor_class -%}smallcaps {% if settings.product_card_text_font == 'heading' %}heading{% endif %}{% endcapture %}
          {%- render 'vendor' with product.vendor, class: vendor_class -%}
        {%- endif -%}

        {%- if show_title or show_prices -%}
          <div class="v-stack justify-items-center gap-1">
            {%- if show_title -%}
              <a href="{{ product.url }}" class="product-title {% if text_class != blank %}{{ text_class }}{% endif %} {% if settings.product_title_max_lines > 0 %}line-clamp{% endif %}" {% if settings.product_title_max_lines > 0 %}style="--line-clamp-count: {{ settings.product_title_max_lines }}"{% endif %} data-instant>
                {{- product.title -}}
              </a>
            {%- endif -%}

            {%- if show_prices -%}
              {%- render 'price-list', product: product, context: 'card' -%}
            {%- endif -%}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if show_swatches and settings.product_color_display != 'hide' -%}
      {%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}

      {%- for color_label in color_label_list -%}
        {%- if product.options_by_name[color_label] != blank -%}
          {%- assign product_option = product.options_by_name[color_label] -%}
          {%- capture name -%}swatch-{{ quick_buy_context }}-{{ section.id }}-{{ product.id }}-{{ product_option.position }}{%- endcapture -%}

          {%- case settings.product_color_display -%}
            {%- when 'count' -%}
              <p class="smallcaps text-subdued">{{- 'product.general.available_colors_count' | t: count: product_option.values.size -}}</p>

            {%- else -%}
              {%- comment -%}
              ----------------------------------------------------------------
              CUSTOM IMAGE SWATCH LOGIC
              ----------------------------------------------------------------
              {%- endcomment -%}
              <fieldset class="h-stack wrap justify-center gap-1" data-option-position="{{ product_option.position }}">
                
                {%- for option_value in product_option.values -%}
                  {%- assign selected = false -%}
                  {%- if forloop.first or product.selected_or_first_available_variant.matched and option_value == product_option.selected_value -%}
                    {%- assign selected = true -%}
                  {%- endif -%}

                  {%- comment -%} Find the image associated with this specific color option {%- endcomment -%}
                  {%- assign swatch_bg_image = '' -%}
                  {%- assign main_swap_image = '' -%}
                  
                  {%- for variant in product.variants -%}
                    {%- if variant.options contains option_value -%}
                      {%- if variant.featured_media != blank -%}
                        {%- assign swatch_bg_image = variant.featured_media | image_url: width: 80, height: 80, crop: 'center' -%}
                        {%- assign main_swap_image = variant.featured_media | image_url: width: 800 -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- comment -%} Fallback if no specific variant image exists, use a blank placeholder or color logic {%- endcomment -%}
                  {%- if swatch_bg_image == blank -%}
                     {%- assign swatch_bg_image = 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png' -%}
                  {%- endif -%}

                  <label 
                    for="{{ name }}-{{ forloop.index }}"
                    class="custom-image-swatch {% if selected %}is-selected{% endif %}"
                    style="
                      display: inline-block;
                      width: 40px; 
                      height: 40px; 
                      background-image: url('{{ swatch_bg_image }}'); 
                      background-size: cover; 
                      background-position: center; 
                      border-radius: 50%; 
                      cursor: pointer;
                      border: 1px solid #e5e5e5;
                      transition: transform 0.2s;
                      position: relative;
                    "
                    title="{{ option_value }}"
                    data-main-image="{{ main_swap_image }}"
                    data-product-id="{{ product.id }}"
                    onclick="updateCardImage(this)"
                  >
                    <input 
                      id="{{ name }}-{{ forloop.index }}"
                      type="radio" 
                      name="{{ name }}" 
                      value="{{ option_value | escape }}" 
                      class="sr-only"
                      {% if selected %}checked{% endif %}
                    >
                    <span class="selection-ring" style="
                        position: absolute;
                        top: -3px; left: -3px; right: -3px; bottom: -3px;
                        border: 1px solid transparent;
                        border-radius: 50%;
                    "></span>
                  </label>

                {%- endfor -%}
              </fieldset>
              
              <style>
                .custom-image-swatch:hover { transform: scale(1.1); }
                .custom-image-swatch.is-selected { border-color: #000 !important; }
                .custom-image-swatch.is-selected .selection-ring { border-color: #000 !important; }
                /* Hide standard radio input */
                .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
              </style>

          {%- endcase -%}

          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if show_rating -%}
      {%- render 'product-rating', product: product, show_empty: settings.show_product_rating_if_empty, display_mode: settings.product_rating_mode -%}
    {%- endif -%}
  </div>
</product-card>

<script>
  function updateCardImage(element) {
    // 1. Get the new image URL from the clicked swatch
    var newImageSrc = element.getAttribute('data-main-image');
    var productId = element.getAttribute('data-product-id');
    
    // 2. Select the radio input inside the label to handle logic
    var input = element.querySelector('input');
    input.checked = true;

    // 3. Update Visual Selection State (Remove class from siblings, add to self)
    var siblings = element.parentElement.querySelectorAll('.custom-image-swatch');
    siblings.forEach(function(el) { el.classList.remove('is-selected'); });
    element.classList.add('is-selected');

    // 4. Find the main image in this product card and update it
    if(newImageSrc && newImageSrc !== '') {
        // We find the image by the product ID we added earlier
        var mainImg = document.getElementById(productId);
        if(mainImg) {
            mainImg.src = newImageSrc;
            mainImg.srcset = newImageSrc; // Update srcset to prevent reverting on resize
        }
    }
  }
</script>